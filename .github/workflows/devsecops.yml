name: Automatisation des tests DevSecOps

on: push

jobs:
  Dependances:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ RÃ©cupÃ©ration du code
        uses: actions/checkout@v4

      - name: ğŸ” VÃ©rification du fichier requirements.txt
        run: |
          echo "ContrÃ´le du fichier requirements.txt..."
          if [ ! -f requirements.txt ]; then
            echo "âŒ Le fichier requirements.txt est manquant !"
            exit 1
          fi

          echo "âœ… Fichier requirements.txt trouvÃ©."
          echo "ğŸ” VÃ©rification du format..."
          if ! grep -E '^[a-zA-Z0-9_.-]+(==[0-9a-zA-Z_.-]+)?$' requirements.txt >/dev/null 2>&1; then
            echo "âš ï¸ Certaines lignes de requirements.txt semblent incorrectes."
          else
            echo "âœ… Le fichier requirements.txt semble bien formÃ©."
          fi

      - name: ğŸ›¡ï¸ Audit de sÃ©curitÃ© des dÃ©pendances (pip-audit)
        run: |
          echo "Installation de pip-audit..."
          python3 -m pip install --upgrade pip pip-audit >/dev/null 2>&1
          echo "Analyse de sÃ©curitÃ© des dÃ©pendances..."
          pip-audit -r requirements.txt || {
            echo "âŒ VulnÃ©rabilitÃ©s dÃ©tectÃ©es dans les dÃ©pendances !"
            exit 1
          }
          echo "âœ… Aucune vulnÃ©rabilitÃ© critique dÃ©tectÃ©e."

  Dockerfile:
    runs-on: ubuntu-latest
    needs: Dependances
    steps:
      - name: ğŸ“¦ RÃ©cupÃ©ration du code
        uses: actions/checkout@v4

      - name: ğŸ§± VÃ©rification du Dockerfile
        run: |
          echo "ContrÃ´le du Dockerfile..."
          if [ ! -f Dockerfile ]; then
            echo "âŒ Le fichier Dockerfile est manquant !"
            exit 1
          fi

          echo "âœ… Dockerfile trouvÃ©."
          echo "ğŸ” Analyse rapide du contenu..."
          if ! grep -q '^FROM' Dockerfile; then
            echo "âŒ Le Dockerfile ne contient pas d'instruction FROM."
            exit 1
          fi

          if ! grep -q '^CMD' Dockerfile && ! grep -q '^ENTRYPOINT' Dockerfile; then
            echo "âš ï¸ Aucune commande CMD ou ENTRYPOINT trouvÃ©e."
          else
            echo "âœ… Dockerfile semble valide."
          fi

      - name: ğŸ§ª Scan de sÃ©curitÃ© Dockerfile (hadolint)
        run: |
          echo "Installation de hadolint (binaire officiel)..."
          wget -qO /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          chmod +x /usr/local/bin/hadolint

          echo "Analyse du Dockerfile avec hadolint..."
          if ! hadolint --failure-threshold error Dockerfile; then
            echo "âš ï¸ ProblÃ¨mes dÃ©tectÃ©s dans le Dockerfile (voir ci-dessus)."
            # Ne fait pas Ã©chouer le pipeline sauf si erreurs critiques
          fi

          echo "âœ… Analyse terminÃ©e."

  Deploy:
    runs-on: ubuntu-latest
    needs: Dockerfile
    steps:
      - name: ğŸš€ Deploy
        run: |
          echo "Votre application est prÃªte Ã  Ãªtre dÃ©ployÃ©e ğŸ‰"
